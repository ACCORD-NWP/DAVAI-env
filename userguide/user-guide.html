<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>User Guide · Davai</title><meta name="title" content="User Guide · Davai"/><meta property="og:title" content="User Guide · Davai"/><meta property="twitter:title" content="User Guide · Davai"/><meta name="description" content="Documentation for Davai."/><meta property="og:description" content="Documentation for Davai."/><meta property="twitter:description" content="Documentation for Davai."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../forge-setup.html">Davai</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../forge-setup.html">Setup</a></li><li><a class="tocitem" href="../forge-branch.html">Prepare branch</a></li></ul></li><li><span class="tocitem">HPC Platforms</span><ul><li><a class="tocitem" href="../belenos.html">Belenos</a></li><li><a class="tocitem" href="../atos_bologna.html">Atos</a></li></ul></li><li class="is-active"><a class="tocitem" href="user-guide.html">User Guide</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Test-an-IAL-development"><span>Test an IAL development</span></a></li><li><a class="tocitem" href="#Create-your-branch,-containing-your-modifications"><span>Create your branch, containing your modifications</span></a></li><li><a class="tocitem" href="#Run-tests"><span>Run tests</span></a></li><li><a class="tocitem" href="#Navigation-in-*Ciboulaï*"><span>Navigation in <em>Ciboulaï</em></span></a></li><li><a class="tocitem" href="#How-it-works,-briefly"><span>How it works, briefly</span></a></li><li><a class="tocitem" href="#More-details"><span>More details</span></a></li><li><a class="tocitem" href="#(Re-)Build-of-executables"><span>(Re-)Build of executables</span></a></li><li><a class="tocitem" href="#Build-options"><span>Build options</span></a></li><li><a class="tocitem" href="#Input-data"><span>Input data</span></a></li><li><a class="tocitem" href="#User-configuration"><span>User configuration</span></a></li><li><a class="tocitem" href="#Parallel-profiling"><span>Parallel profiling</span></a></li><li><a class="tocitem" href="#Experts-thresholds"><span>Experts thresholds</span></a></li><li><a class="tocitem" href="#Versioning-of-tests"><span>Versioning of tests</span></a></li><li><a class="tocitem" href="#Internal-organization-of-DAVAÏ"><span>Internal organization of DAVAÏ</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="user-guide.html">User Guide</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="user-guide.html">User Guide</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/roelstappers/DAVAI-env" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/roelstappers/DAVAI-env/blob/master/doc/src/userguide/user-guide.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="DAVAÏ-User-Guide"><a class="docs-heading-anchor" href="#DAVAÏ-User-Guide">DAVAÏ User Guide</a><a id="DAVAÏ-User-Guide-1"></a><a class="docs-heading-anchor-permalink" href="#DAVAÏ-User-Guide" title="Permalink"></a></h1><p>A. Mary </p><p>DAVAÏ embeds the whole workflow from the source code to the green/red light validation status: fetching sources from Git, building executables, running test cases, analysing the results and displaying them on a dashboard.</p><p>For now, the only build system embedded is <code>gmkpack</code>, but we expect other systems to be plugged when required. The second limitation of this version is that the starting point is still an IAL<sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup> Git reference only. The next version of the DAVAÏ system will include multi-projects/repositories fetching, using the <em><code>bundle</code></em> concept as starting point.</p><p>The dimensioning of tests (grid sizes, number of observations, parallelization...) is done in order to conceal representativity and execution speed. Therefore, in the general usecases, the tests are supposed to run on HPC. A dedicated usecase will target smaller configurations to run on workstation (not available yet). An accessible source code forge is set within the ACCORD consortium to host the IAL central repository on which updates and releases are published, and where integration requests will be posted, reviewed and monitored.</p><p>By the way: DAVAI stands for <em>&quot;<strong>D</strong>evice <strong>A</strong>iming at the <strong>VA</strong>lidation of <strong>I</strong>AL&quot;</em></p><h1 id="Test-an-IAL-development"><a class="docs-heading-anchor" href="#Test-an-IAL-development">Test an IAL development</a><a id="Test-an-IAL-development-1"></a><a class="docs-heading-anchor-permalink" href="#Test-an-IAL-development" title="Permalink"></a></h1><h2 id="Create-your-branch,-containing-your-modifications"><a class="docs-heading-anchor" href="#Create-your-branch,-containing-your-modifications">Create your branch, containing your modifications</a><a id="Create-your-branch,-containing-your-modifications-1"></a><a class="docs-heading-anchor-permalink" href="#Create-your-branch,-containing-your-modifications" title="Permalink"></a></h2><p>To use DAVAÏ to test your contribution to the next development release, you need to have your code in a Git branch starting from the latest official release (e.g. <code>CY48T1</code> tag for contributions to 48T2, or <code>CY49</code> tag for contributions to 49T1).</p><p>In the following the example is taken on a contribution to 48T2:</p><ol><li><p>In your repository (e.g. <code>~/repositories/arpifs</code> – make sure it is clean with <code>git status</code> beforehand), create your branch:</p><p><code>bash   git checkout -b &lt;my_branch&gt; [&lt;starting_reference&gt;]</code></p><p>(e.g. <code>git checkout -b mary_CY48T1_cleaning CY48T1</code>)  !!! note it is strongly recommended to have explicit branch names with regards to their origin and their owner, hence the legacy branch naming syntax <code>&lt;user&gt;_&lt;CYCLE&gt;_&lt;purpose_of_the_branch&gt;</code></p></li><li><p>Implement your developments in the branch.  <em>It is recommended to find a compromise between a whole development in only one commit, and a large number of very small commits (e.g.  one by changed file).</em> In case you then face compilation or runtime issues then, but only if you haven&#39;t pushed it yet, you can <em>amend</em><sup class="footnote-reference"><a id="citeref-2" href="#footnote-2">[2]</a></sup> the latest commit to avoid a whole series of commits  just for debugging purpose.  !!! note       DAVAÏ is currently able to include non-committed changes in the compilation and testing. However, in the next version based on <em>bundle</em>, this might not be possible anymore.  </p></li></ol><h2 id="Run-tests"><a class="docs-heading-anchor" href="#Run-tests">Run tests</a><a id="Run-tests-1"></a><a class="docs-heading-anchor-permalink" href="#Run-tests" title="Permalink"></a></h2><h3 id="Setup-your-experiment"><a class="docs-heading-anchor" href="#Setup-your-experiment">Setup your experiment</a><a id="Setup-your-experiment-1"></a><a class="docs-heading-anchor-permalink" href="#Setup-your-experiment" title="Permalink"></a></h3><ol><li><p>Create your experiment, specifying which version of the tests you  want to use:</p><p><code>davai-new_xp &lt;my_branch&gt; -v &lt;tests_version&gt;</code></p><p>(e.g. <code>davai-new_xp mary_CY48T1_cleaning -v DV48T1</code>)  <span>$\hookrightarrow$</span> An experiment with a unique experiment ID is  created and prompted as output of the command, together with its  path.</p><ul><li><p>to know what is the version to be used for a given development: See <a href="https://github.com/ACCORD-NWP/DAVAI-tests/wiki">here</a>`</p></li><li><p>see <code>davai-new_xp -h</code> for more options on this command</p></li><li><p>see   Appendix <a href="user-guide.html#sect:tests_versioning">[sect:tests_versioning]</a>{reference-type=&quot;ref&quot;   reference=&quot;sect:tests_versioning&quot;} for a more comprehensive   approach to tests versioning.</p></li><li><p>if the version you are requesting is not known, you may need to   specify the DAVAI-tests origin repository from which to   clone/fetch it, using argument   <code>–origin &lt;URL of the remote DAVAI-tests.git&gt;</code></p></li></ul></li><li><p><span>$\hookrightarrow$</span> Go to the (prompted) experiment directory.<br/> <br/> If you want to set some options differently from the default, open  file <code>conf/davai_nrv.ini</code> and tune the parameters in the <code>[DEFAULT]</code>  section. The usual tunable parameters are detailed in  Section <a href="user-guide.html#sect:options">[sect:options]</a>{reference-type=&quot;ref&quot;  reference=&quot;sect:options&quot;}.</p></li><li><p>Launch the build and tests:</p><p><code>davai-run_xp</code></p><p>After initializing the Ciboulaï page for the experiment, the command  will first run the build of the branch and wait for the executables  (that step may take a while, depending on the scope of your  modifications, especially with several compilation flavours). Once  build completed, it will then launch the tests (through scheduler on  HPC).</p></li></ol><h3 id="Monitor-and-inspect-results"><a class="docs-heading-anchor" href="#Monitor-and-inspect-results">Monitor and inspect results</a><a id="Monitor-and-inspect-results-1"></a><a class="docs-heading-anchor-permalink" href="#Monitor-and-inspect-results" title="Permalink"></a></h3><ol><li><p>Monitor the execution of the jobs with the scheduler (with SLURM:  <code>squeue -u &lt;user&gt;</code>)</p></li><li><p>Check the tests results summary on the <em>Ciboulaï</em> dashboard, which  URL is prompted at the end of tests launch, or visible in the config  file:</p><ul><li><p>open <em>Ciboulaï</em> dashboard in a web browser:   (<a href="https://www.umr-cnrm.fr/davai/">https://www.umr-cnrm.fr/davai/</a>)</p><ul><li><p>To guide you in the navigation in <em>Ciboulaï</em>, cf.   Section <a href="user-guide.html#sect:ciboulai_navigation">[sect:ciboulai_navigation]</a>{reference-type=&quot;ref&quot;   reference=&quot;sect:ciboulai_navigation&quot;}.</p></li><li><p>To get the paths to a job output or abort directory: button   <code>[+]</code> then ***Context***.</p></li></ul></li><li><p>if the dashboard is not accessible, a command-line version of   the status is possible; in the XP directory, run:</p><p><code>davai-xp_status</code></p><p>to see the status summary of each job. The detailed status and   expertise of tests are also available as json files on the   Vortex cache:<br/>  <code>belenos:/scratch/mtool/&lt;user&gt;/cache/vortex/davai/&lt;vconf&gt;/&lt;xpid&gt;/summaries_stack/</code><br/>  or</p><p><code>davai-xp_status -t &lt;task&gt;</code></p><p><span>$\Rightarrow$</span> To get the paths to a job output or abort   directory: <code>davai-xp_status -t &lt;task&gt;</code> then open the <code>itself</code>   file and look in the ***Context*** section.</p></li></ul></li></ol><h3 id="And-then-?-{#and-then-.unnumbered}"><a class="docs-heading-anchor" href="#And-then-?-{#and-then-.unnumbered}">And then ? {#and-then .unnumbered}</a><a id="And-then-?-{#and-then-.unnumbered}-1"></a><a class="docs-heading-anchor-permalink" href="#And-then-?-{#and-then-.unnumbered}" title="Permalink"></a></h3><ul><li><p>If everything is OK (green) at the end of executions, your branch is   validated !</p></li><li><p>If not, cf.   Section <a href="user-guide.html#sect:options">[sect:options]</a>{reference-type=&quot;ref&quot;   reference=&quot;sect:options&quot;} to re-compile a code modification and   re-run tests.</p></li></ul><h3 id="First-tips"><a class="docs-heading-anchor" href="#First-tips">First tips</a><a id="First-tips-1"></a><a class="docs-heading-anchor-permalink" href="#First-tips" title="Permalink"></a></h3><ul><li><p>All Davai commands are prefixed <code>davai-*</code> and can be listed with   <code>davai-help</code>. All commands are auto-documented with option <code>-h</code>.</p></li><li><p>If the <strong>pack preparation or compilation fails</strong>, for whatever   reason, the build step prints an error message and the   <code>davai-run_xp</code> command stops before running the tests. You can find   the output of the pack preparation or compilation in <code>logs/</code>   directory, as any other test log file.<br/>  A very common error is when the pack already exists; if you actually   want to overwrite the contents of the pack (e.g. because you just   fixed a code issue in the branch), you may need option   <code>-e/–preexisting_pack</code>:</p><p><code>davai-run_xp -e</code><br/>  or<br/>  <code>davai-build -e</code></p><p>Otherwise, if the pack preexists independantly for valid reasons,   you will need to move/delete the existing pack, or rename your   branch.</p></li><li><p>The tests are organised as ***tasks*** and ***jobs***:</p><ul><li><p>a ***task*** consists in fetching input resources, running an   executable, analyzing its outputs to the Ciboulai dashboard and   dispatching (archiving) them: <em>1 test = 1 task</em></p></li><li><p>a ***job*** consists in a sequential driver of one or several   <em>task(s)</em>: either a flow sequence (i.e. outputs of task N is an   input of task N+1) or family sequence (e.g. run independantly an   IFS and an Arpege forecast)</p></li></ul></li><li><p>To <strong>fix a piece of code</strong>, the best is to modify the code in your   Git repo, then re-run</p><p><code>davai-run_xp -e</code> (or <code>davai-build -e</code> and then <code>davai-run_tests</code>).</p><p>You don&#39;t necessarily need to commit the change rightaway, the   non-committed changes are exported from Git to the pack. Don&#39;t   forget to commit eventually though, before issuing pull request.</p></li><li><p>To <strong>re-run one job only after re-compilation</strong>, type<br/>  <code>davai-run_tests -l</code><br/>  to list the jobs and then<br/>  <code>davai-run_tests &lt;category.job&gt;</code><br/>  e.g.<br/>  <code>davai-run_tests forecasts.standalone_forecasts</code></p></li><li><p>The syntax <code>category.job</code> indicates that the job to be run is the   ***Driver*** in <code>./tasks/category/job.py</code></p></li><li><p>To <strong>re-run a single test</strong> within a job, e.g. the IFS forecast in   <code>forecasts/standalone_forecasts.py</code>: edit this file, comment the   other <code>Family</code>(s) or <code>Task</code>(s) (<em>nodes</em>) therein, and re-run the job   as indicated above.</p></li><li><p><strong>Eventually</strong>, after code modifications and fixing particular   tests, you should re-run <strong>the whole set of tests</strong>, to make sure   your fix does not break any other test.</p></li></ul><h2 id="Navigation-in-*Ciboulaï*"><a class="docs-heading-anchor" href="#Navigation-in-*Ciboulaï*">Navigation in <em>Ciboulaï</em></a><a id="Navigation-in-*Ciboulaï*-1"></a><a class="docs-heading-anchor-permalink" href="#Navigation-in-*Ciboulaï*" title="Permalink"></a></h2><p><a href="http://intra.cnrm.meteo.fr/gws/davai">http://intra.cnrm.meteo.fr/gws/davai</a></p><ul><li><p>On the main page, the numbers in the columns to the right indicate   the numbers of jobs which results are respectively:</p><ul><li><p>: bit-reproducible or within acceptable numerical error;</p></li><li><p>: numerically different;</p></li><li><p>: jobs that have crashed before end;</p></li><li><p>: the experts were not able to state on the test results, to be   checked manually;</p></li><li><p>: these tests have no expected result to be checked: they are   assumed OK since they did not crash.</p></li></ul></li><li><p>When you get to an experiment page, you can find a few key features   of the experiment, in the header. The <code>[+]</code> close to the XPID   (experiment ID) will provide more. The others <code>[+]</code> to the left of   the <em><code>uenv</code></em>&#39;s provide inner details from each one.<br/>  The summary of tests results is also visible on the top right.</p></li><li><p>Each task is summarized: its Pending/Crashed/Ended status, and in   case of Ended, the comparison status. As a first glance, a main   metric is shown, assumed to be the most meaningful for this test.</p></li><li><p>The <code>‘drHook rel diff’</code> and <code>‘rss rel diff’</code> columns show the   relative difference in respectively: the elapse time of the   execution, and the memory consumption (RSS) compared to the   reference. ***However, so far the drHook figures have proven to be   too volatile from an execution to another, to be meaningful. Don&#39;t   pay too much attention, for now. Similarly, the RSS figures remain   to be investigated (relevance and availability).***</p></li><li><p>A filter is available to show only a subset of tasks.</p></li><li><p>When you click on the <code>[+]</code> of the <em><code>more</code></em> column, the detailed   expertise is displayed:</p><ul><li><p>the <em><code>itself</code></em> tab will show info from each Expert about the   task independantly from reference</p></li><li><p>the <em><code>continuity</code></em> tab will show the compared results from each   Expert against the same task from <em>reference</em> experiment</p></li><li><p>the <em><code>consistency</code></em> tab will show the compared results from each   Expert against a different <em>reference</em> task from the same   experiment, when meaningful (very few cases, so far)</p></li></ul><p>Click on each Expert to unroll results.</p></li><li><p>At the experiment level as well as at the task level, a little pen   symbol enables you to annotate it. That might be used for instance   to justify numerical differences.</p></li></ul><h2 id="How-it-works,-briefly"><a class="docs-heading-anchor" href="#How-it-works,-briefly">How it works, briefly</a><a id="How-it-works,-briefly-1"></a><a class="docs-heading-anchor-permalink" href="#How-it-works,-briefly" title="Permalink"></a></h2><h3 id="Organisation-of-an-experiment"><a class="docs-heading-anchor" href="#Organisation-of-an-experiment">Organisation of an experiment</a><a id="Organisation-of-an-experiment-1"></a><a class="docs-heading-anchor-permalink" href="#Organisation-of-an-experiment" title="Permalink"></a></h3><p>The <code>davai-new_xp</code> command-line prepares a &quot;testing experiment&quot; directory, named uniquely after an incremental number, the platform and the user.</p><p>This testing experiment will consist in:</p><ul><li><p><code>conf/davai_nrv.ini</code> : config file, containing parameters such as   the git reference to test, davai options, historisations of input   resources to use, tunings of tests (e.g. the input obs files to take   into account) and profiles of jobs</p></li><li><p><code>conf/&lt;USECASE&gt;.yaml</code> : contains an ordered and categorised list of   jobs to be ran in the requested usecase.</p></li><li><p><code>conf/sources.yaml</code> : information about the sources to be tested, in   terms of Git or bundle</p></li><li><p><code>tasks/</code> : templates of single tasks and jobs</p></li><li><p>links to the python packages that are used by the scripts (<code>vortex</code>,   <code>epygram</code>, <code>ial_build</code>, <code>ial_expertise</code>)</p></li><li><p>a <code>logs</code> directory/link will appear after the first execution,   containing log files of each job.</p></li><li><p><code>DAVAI-tests</code> : a clone of the DAVAI-tests repository, checkedout on   the requested version of the tests, on which point the <code>tasks/</code> and   <code>conf/</code></p></li></ul><h3 id="Running-jobs-on-HPC-:-MTOOL"><a class="docs-heading-anchor" href="#Running-jobs-on-HPC-:-MTOOL">Running jobs on HPC : <code>MTOOL</code></a><a id="Running-jobs-on-HPC-:-MTOOL-1"></a><a class="docs-heading-anchor-permalink" href="#Running-jobs-on-HPC-:-MTOOL" title="Permalink"></a></h3><p>On HPCs, the compute nodes are &quot;expensive&quot; and so we try as much as possible to save the elapse time spent on compute nodes for actual computations, i.e. execution of the executable. Therefore in DAVAÏ, the generation of the scripts uses the <code>MTOOL</code> filter to replicate and cut a job script into several ***steps***:</p><ol><li><p>on transfer nodes, fetch the resources, either locally on the file  system(s) or using FTP connections to outer machines</p></li><li><p>on compute nodes, execute the AlgoComponent(s)</p></li><li><p>on transfer nodes, dispatch the produced output</p></li><li><p>final step to clean the temporary environment created for the jobs</p></li></ol><p>In addition to this separation and chaining these 4 steps, <code>MTOOL</code> initially sets up a clean environment with a temporary unique execution directory. It also collects log files of the script&#39;s execution, and in the case of a failure (missing input resources, execution aborted), it takes a screenshot of the execution directory. Therefore for each job, one will find :</p><ul><li><p>a ***depot*** directory in which to find the actual 4 scripts and   their log files</p></li><li><p>an ***abort*** directory, in which to find the exact copy of the   execution directory when the execution failed</p></li></ul><p>These directories are registered by the DAVAÏ expertise and are displayed in the ***Context*** item of the expertise for each task in <em>Ciboulaï</em>.</p><h3 id="Jobs-and-tasks"><a class="docs-heading-anchor" href="#Jobs-and-tasks">Jobs &amp; tasks</a><a id="Jobs-and-tasks-1"></a><a class="docs-heading-anchor-permalink" href="#Jobs-and-tasks" title="Permalink"></a></h3><p>A <em>Task</em> is generally understood as the triplet: (1) fetch input resources, (2) run an executable, (3) dispatch the produced output. In a Vortex script, the tasks are written in Python, using classes and functionalities of the Vortex Python packages. In particular, running an executable is wrapped in what is called an <em>AlgoComponent</em>. In DAVAÏ, we add a second <em>AlgoComponent</em> right after the nominal one in (2) to <em>&quot;expertise&quot;</em> the outputs and compare to a reference.</p><p>The tasks templates are stored in the <code>tasks/</code> directory, and all inherit from the abstract class:<br/><code>vortex.layout.nodes.Task</code>. A <em>Test</em> is a Task that includes an expertise to a reference.<br/>A <em>Job</em> is understood as a series of one or several tasks, executed sequentially within one &quot;job submission&quot; to a job scheduler.</p><p>The jobs templates are stored in the <code>tasks/</code> directory, and are defined as a function <code>setup</code> that return a <code>Driver</code> object, which itself contains a series of <code>Task</code>(s) and <code>Family</code>(ies).</p><p>In DAVAÏ, the idea is to have the tasks in independant jobs as far as possible, except: for flow-dependant tasks, or for loops on clones of a task with a varying parameter.</p><h2 id="More-details"><a class="docs-heading-anchor" href="#More-details">More details</a><a id="More-details-1"></a><a class="docs-heading-anchor-permalink" href="#More-details" title="Permalink"></a></h2><h2 id="(Re-)Build-of-executables"><a class="docs-heading-anchor" href="#(Re-)Build-of-executables">(Re-)Build of executables</a><a id="(Re-)Build-of-executables-1"></a><a class="docs-heading-anchor-permalink" href="#(Re-)Build-of-executables" title="Permalink"></a></h2><h3 id="Build-with-gmkpack"><a class="docs-heading-anchor" href="#Build-with-gmkpack">Build with <code>gmkpack</code></a><a id="Build-with-gmkpack-1"></a><a class="docs-heading-anchor-permalink" href="#Build-with-gmkpack" title="Permalink"></a></h3><p>The tasks in the <code>build</code> job are respectively in charge of:</p><ul><li><p><code>gitref2pack</code> : fetch/pull the sources from the requested Git   reference and set one or several incremental <code>gmkpack</code>&#39;s pack(s) –   depending on <code>compilation_flavours</code> as set in config. The packs are   then populated with the set of modifications, from the latest   official tag to the contents of your branch (including non-commited   modifications).</p></li><li><p><code>pack2bin</code> : compile sources and link necessary executables (i.e.   those used in the tests), for each pack flavour.</p></li></ul><p>In case the compilation fails, or if you need to (re-)modify the sources for any reason (e.g. fix an issue):</p><ol><li><p>implement corrections in the branch (commited or not)</p></li><li><p>re-run the build:<br/> <code>davai-build -e</code><br/> (option <code>-e</code> or <code>–preexisting_pack</code> assumes the pack already  preexists; this is a protection against accidental overwrite of an  existing pack. The option can also be passed to <code>davai-run_xp</code>)</p></li><li><p>and then if build successful <code>davai-run_tests</code></p></li></ol><h3 id="Build-with-[cmake/makeup/ecbuild...]"><a class="docs-heading-anchor" href="#Build-with-[cmake/makeup/ecbuild...]">Build with [cmake/makeup/ecbuild...]</a><a id="Build-with-[cmake/makeup/ecbuild...]-1"></a><a class="docs-heading-anchor-permalink" href="#Build-with-[cmake/makeup/ecbuild...]" title="Permalink"></a></h3><p>Not implemented yet.</p><h3 id="Re-run-a-test"><a class="docs-heading-anchor" href="#Re-run-a-test">Re-run a test</a><a id="Re-run-a-test-1"></a><a class="docs-heading-anchor-permalink" href="#Re-run-a-test" title="Permalink"></a></h3><p>The Davai command <code>davai-run_tests</code> launches all the jobs listed in <code>conf/&lt;USECASE&gt;.yaml</code>, sequentially and independantly (i.e. without waiting for the jobs to finish). The command can also be used complementary:</p><ul><li><p>to list the jobs that would be launched by the command, according to   the <code>conf/&lt;USECASE&gt;.yaml</code> config file:   <code>davai-run_tests -l</code></p></li><li><p>to run a single job:</p><p><code>davai-run_tests &lt;job identifier as given by -l option&gt;</code></p></li></ul><p>Some tests are gathered together within a single job. There are 2 reasons for that: if they are an instance of a loop (e.g. same test on different obstypes, or different geometries), or if they have a flow-dependancy with an upstream/downstream test (e.g. bator <span>$&gt;$</span> screening <span>$&gt;$</span> minimization).</p><p>When a test fails within a job and the user wants to re-run it without re-runnning the other tests from the same job, it is possible to do so by deactivating them<sup class="footnote-reference"><a id="citeref-3" href="#footnote-3">[3]</a></sup> :</p><ul><li><p><strong>loops:</strong> to deactivate members of a loop:<br/>  open config file <code>conf/davai_.ini</code>, and in the section corresponding   to the job or family, the loops can be found as <code>list(...)</code>, e.g.   <code>obstypes</code>, <code>rundates</code> or <code>geometrys</code>. Items in the list can be   reduced to the only required ones (note that if only one item   remains, one needs to keep a final <code>&quot;,&quot;</code> within the parenthesis).</p></li><li><p><strong>dependancy:</strong> open driver file corresponding to the job name in   <code>tasks/</code> directory, and comment out (<code>#</code>) the unrequired tasks or   families of <em><code>nodes</code></em>, leaving only the required task.</p></li></ul><h3 id="Investigating-a-problem"><a class="docs-heading-anchor" href="#Investigating-a-problem">Investigating a problem</a><a id="Investigating-a-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Investigating-a-problem" title="Permalink"></a></h3><p>The <strong>usecase</strong> parameter of an experiment (to be set in the <code>davai-new_xp</code> command) determines the span of tests to be generated and run. Several usecases have been <em>(or will be)</em> implemented with various purposes:</p><ul><li><p><code>NRV</code> (default): Non-Regression Validation, minimal set of tests   that any contribution must pass.</p></li><li><p><code>ELP</code>: Exploration and Localization of Problems, extended set of   isolated components, to help localizing an issue</p></li><li><p><em><code>PC</code>: [not implemented yet] set of toy tests ported on   workstation; the compilation with GNU (usually less permissive than   vendor compilers) enables to raise issues that might not have been   seen with NRV/ELP tests.</em></p></li></ul><h3 id="Smaller-tests-for-smaller-problems"><a class="docs-heading-anchor" href="#Smaller-tests-for-smaller-problems">Smaller tests for smaller problems</a><a id="Smaller-tests-for-smaller-problems-1"></a><a class="docs-heading-anchor-permalink" href="#Smaller-tests-for-smaller-problems" title="Permalink"></a></h3><p>To investigate a non-reproducibility or crash issue, the <code>ELP</code> usecase of Davaï can help localizing its context, with a set of more elementary tests, that run smaller parts of code.</p><p>To switch to this mode:</p><ul><li><p>create a new experiment with the same arguments but <code>-u ELP</code> and go   in it</p></li><li><p>for a faster build (no re-compilation), edit config file   <code>conf/davai_elp.ini</code> and in section <code>[gitref2pack]</code>, set   <code>cleanpack = False</code></p></li><li><p><code>davai-run_xp</code></p></li></ul><p>Instead of 50<span>$^+$</span> tests, the ELP mode will provide hundreds of more elementary and focused tests. For instance, if you had a problem in the 4DVar minimization, you can run the 3 observation operators tests, observation by observation, and/or a screening, and/or a 3DVar or 4DVar single-obs minimization, in order to understand if the problem is in a specific observation operator (which obs type ?), in its direct, TL or AD version, or in the Variational algorithm, or in the preceding screening, and so on...</p><p>The user may want, at some point, to run only a subset of this very large set of tests. In this case, simply open the <code>conf/ELP.yaml</code> and comment (<code>#</code>) the launch of the various jobs. To reduce the number of tests that are innerly looped, e.g. the loop on observation types within the <code>*__obstype</code> jobs: open config file <code>conf/davai_elp.ini</code>, look for the section named after job name and select the obstype(s) to be kept only in list.</p><h2 id="Build-options"><a class="docs-heading-anchor" href="#Build-options">Build options</a><a id="Build-options-1"></a><a class="docs-heading-anchor-permalink" href="#Build-options" title="Permalink"></a></h2><p>The choice of a build system is corollary to the versioning of the tests. However, at time of writing, only <code>gmkpack</code> is available within DAVAÏ.</p><h3 id="Build-with-gmkpack-2"><a class="docs-heading-anchor" href="#Build-with-gmkpack-2">Build with <code>gmkpack</code></a><a class="docs-heading-anchor-permalink" href="#Build-with-gmkpack-2" title="Permalink"></a></h3><p>In the <code>[gmkpack]</code> section of config file <code>conf/davai_.ini</code>:</p><ul><li><p>to make a main pack, instead of an incremental pack<br/>  <span>$\hookrightarrow$</span> set <code>packtype = main</code></p></li><li><p>to set the list of compilation flavours to build (a.k.a. compiler   label/flag)<br/>  <span>$\hookrightarrow$</span> use <code>compilation_flavours</code><br/>  ! if you modify this, you potentially need to modify the   <code>compilation_flavour</code> accordingly in the &quot;families&quot; sections that   define it, as well as the <code>programs_by_flavour</code> that define the   executables to be built for specific flavours</p></li></ul><p>In the <code>[gitref2pack]</code> section:</p><ul><li><p>to use a different <code>$ROOTPACK</code> (i.e. a different source of ancestor   packs, for incremental packs)<br/>  <span>$\hookrightarrow$</span> use <code>rootpack</code><br/>  (preferably to modifying the environment variable, so that will be   specific to that experiment only)</p></li><li><p>to avoid cleaning all <code>.o</code> and <code>.a</code> when (re-)populating the pack:<br/>  <span>$\hookrightarrow$</span> set <code>cleanpack = False</code><br/></p></li></ul><p>In the <code>[pack2bin]</code> section:</p><ul><li><p>to make the <code>pack2bin</code> task crash more quickly after a   compilation/link error, or do not crash at all<br/>  <span>$\hookrightarrow$</span> set <code>fatal_build_failure =</code></p><ul><li><p><code>__finally__</code> <span>$\Rightarrow$</span> crash after trying to compile and   build all executables</p></li><li><p><code>__any__</code> <span>$\Rightarrow$</span> crash if compilation fails or right   after the first executable linking to fail</p></li><li><p><code>__none__</code> <span>$\Rightarrow$</span> never == ignore failed builds</p></li></ul></li><li><p>to re-generate <code>ics_</code> files before building<br/>  <span>$\hookrightarrow$</span> set <code>regenerate_ics = True</code></p></li><li><p>to (re-)compile local sources with <code>gmkpack’s</code> option <code>Ofrt=2</code> (i.e.   <code>-O0 -check bounds</code>):<br/>  <span>$\hookrightarrow$</span> set <code>Ofrt = 2</code></p></li><li><p>to use more/less threads for compilating (independant) sources files   in parallel:<br/>  <span>$\hookrightarrow$</span> use <code>threads</code></p></li><li><p>to change the list of executables to be built, by default or   depending on the compilation flavour:<br/>  <span>$\hookrightarrow$</span> use <code>default_programs</code> and <code>programs_by_flavour</code></p></li></ul><p>Also, any <code>gmkpack</code> native variables can be set in the <code>.bash_profile</code>, e.g. <code>ROOTPACK, HOMEPACK</code>, etc... Some might be overwritten by the config, e.g. if you set <code>rootpack</code> in config file.</p><h3 id="Build-with-[cmake/makeup/ecbuild...]-2"><a class="docs-heading-anchor" href="#Build-with-[cmake/makeup/ecbuild...]-2">Build with [cmake/makeup/ecbuild...]</a><a class="docs-heading-anchor-permalink" href="#Build-with-[cmake/makeup/ecbuild...]-2" title="Permalink"></a></h3><p>Not implemented yet.</p><h2 id="Input-data"><a class="docs-heading-anchor" href="#Input-data">Input data</a><a id="Input-data-1"></a><a class="docs-heading-anchor-permalink" href="#Input-data" title="Permalink"></a></h2><p>DAVAÏ gets its input data through 2 providers:</p><ul><li><p><em>&quot;shelves&quot;</em> (pseudo Vortex experiments) for the data supposed to   flow in real case (e.g. initial conditions file, observations files,   etc...), where this data is statically stored, usually in a cache   to fetch it faster</p></li><li><p><em>&quot;uget&quot;</em> for the static data (namelists, climatologic files,   parameter files...), catalogued in ***uenv*** files.</p></li></ul><p>These <em>shelves</em> and <em>uenv</em> catalogs (cf. <em>uget/uenv</em> help documentation for the use of this tool.) can be modified in the <code>[DEFAULT]</code> section of config file.</p><p>In case your contribution needs a modification in these, ***don&#39;t forget to describe these changes in the integration request***.</p><h3 id="Other-options"><a class="docs-heading-anchor" href="#Other-options">Other options</a><a id="Other-options-1"></a><a class="docs-heading-anchor-permalink" href="#Other-options" title="Permalink"></a></h3><p>In the <code>[DEFAULT]</code> section, a few other general options can be set to tune the behaviour of the experiment:</p><ul><li><p><code>expertise_fatal_exceptions</code> to raise/ignore errors that could occur   in the expertise subsequent to the tests</p></li><li><p><code>drhook_profiling</code> to activate DrHook profiling or not</p></li><li><p><code>ignore_reference</code> to force to ignore reference outputs (and so   deactivate comparison)</p></li><li><p><code>archive_as_ref</code> to archive the outputs (saving of a reference only)</p></li></ul><h2 id="User-configuration"><a class="docs-heading-anchor" href="#User-configuration">User configuration</a><a id="User-configuration-1"></a><a class="docs-heading-anchor-permalink" href="#User-configuration" title="Permalink"></a></h2><p>Some more general parameters are configurable, such as the default directory in which the experiments are stored, or the directory in which the logs of jobs are put. This can be set in <code>\sim/.davairc/user_config.ini</code>. If the user, for whatever reason, needs to modify the packages linked in the experiments on a regular basis, it is possible to specify that in the same user config file. An example of these variables is available in the <code>DAVAI-env</code> repository, under <code>templates/user_config.ini</code>.</p><h2 id="Parallel-profiling"><a class="docs-heading-anchor" href="#Parallel-profiling">Parallel profiling</a><a id="Parallel-profiling-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-profiling" title="Permalink"></a></h2><p>Each job has a section in the config file, in which one can tune the requested profile parameters to the jobs scheduler:</p><ul><li><p><code>time</code> : elapse time</p></li><li><p><code>ntasks</code> : number of MPI tasks per node</p></li><li><p><code>nnodes</code> : number of nodes</p></li><li><p><code>openmp</code> : number of OpenMP threads</p></li><li><p><code>partition</code> : category of nodes</p></li><li><p><code>mem</code> : memory (helps to prevent OOM)</p></li></ul><p>The total number of MPI tasks is therefore <code>nnodes \times ntasks</code>, and is automatically replaced in namelist</p><h2 id="Experts-thresholds"><a class="docs-heading-anchor" href="#Experts-thresholds">Experts thresholds</a><a id="Experts-thresholds-1"></a><a class="docs-heading-anchor-permalink" href="#Experts-thresholds" title="Permalink"></a></h2><p><em>Experts</em> are the tools developed to parse outputs of the tasks and compare them to a reference. Each expert has its expertise field: norms, Jo-tables, etc...</p><p>See <em>Information on experts</em> in the left tab of Ciboulaï to get information about the tunable thresholds of the various experts (e.g. the allowed error on Jo). Then, set according attributes in the experts definitions in the concerned tasks.</p><p>Again, if you need to modify these, please ***explain and describe in the integration request***.</p><h2 id="Versioning-of-tests"><a class="docs-heading-anchor" href="#Versioning-of-tests">Versioning of tests</a><a id="Versioning-of-tests-1"></a><a class="docs-heading-anchor-permalink" href="#Versioning-of-tests" title="Permalink"></a></h2><p>The following reasons may require to update the tests:</p><ol><li><p>Update the input resources or a task template script, to <strong>change  the purpose or context of a test</strong> (e.g. new observations or  modified namelists, to pull the tests more closely to operational  configurations, ...). This usually comes with a change in the  targeted tests outputs.</p></li><li><p>Add <strong>new tests</strong>.</p></li><li><p>Update the resources to <strong>adapt to a code change</strong> (e.g. new  radiative coefficients files format, or a mandatory namelist  change), with or without change in the results.</p></li></ol><p>Therefore it is necessary to track the evolutions of the tests properly, and version them clearly, so that it is clear what fixed or evolving version is to be used in any context. Hence the existence of the <code>DAVAI-tests</code> repository.<br/>The first two kinds of evolutions (a. and b.) are not necessarily linked to a contribution of code to the IAL repository, and therefore can be implemented at any moment in a dedicated branch of the tests repository (<code>DAVAI-tests</code>). This is described in more details in section <a href="user-guide.html#sect:add-modify-tests">[sect:add-modify-tests]</a>{reference-type=&quot;ref&quot; reference=&quot;sect:add-modify-tests&quot;}.</p><p>The latter is on the other hand attached to a contribution, and will require to be given together with the contribution for an integration, and be integrated itself in an evolving tests branch dedicated to test successive steps of the IAL integration branch. This case is detailed in more details in section <a href="user-guide.html#sect:parallel-branches">[sect:parallel-branches]</a>{reference-type=&quot;ref&quot; reference=&quot;sect:parallel-branches&quot;}.</p><p>To follow more easily what version of the tests should be used in particular for contributions to the IAL codes, it is proposed to adopt a nomenclature that maps the IAL releases and integration/merge branches, but replacing <code>&quot;CY&quot;</code> by <code>&quot;DV&quot;</code> (for DAVAÏ), as illustrated on Figure <a href="user-guide.html#fig:tests_versioning">[fig:tests_versioning]</a>{reference-type=&quot;ref&quot; reference=&quot;fig:tests_versioning&quot;}. With this principle, the version of the tests to be used <em>by default</em> would be, for example:</p><ul><li><p>for a development based on <code>CY49</code> <span>$\rightarrow$</span> <code>DV49</code></p></li><li><p>for an integration branch towards <code>CY49T1</code>, named <code>dev_CY49_to_T1</code>   <span>$\rightarrow$</span> <code>dev_DV49_to_T1</code></p></li></ul><h3 id="Adding-or-updating-tests-independently-from-the-code"><a class="docs-heading-anchor" href="#Adding-or-updating-tests-independently-from-the-code">Adding or updating tests independently from the code</a><a id="Adding-or-updating-tests-independently-from-the-code-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-or-updating-tests-independently-from-the-code" title="Permalink"></a></h3><p>The tests modifications which are not intrinsically linked with a contribution (adding tests or modifying a test to modify its behaviour) can be done at any moment, in a development branch of the tests repository. However, in order not to disturb the users and integrators, they should be merged into the next official version of tests (i.e. the version used for contributions and integrations to IAL) [only between a declaration of an IAL release and a call for contribution]{.underline}.</p><h3 id="Evolution-of-the-tests-w.r.t.-Integration-of-an-IAL-release"><a class="docs-heading-anchor" href="#Evolution-of-the-tests-w.r.t.-Integration-of-an-IAL-release">Evolution of the tests w.r.t. Integration of an IAL release</a><a id="Evolution-of-the-tests-w.r.t.-Integration-of-an-IAL-release-1"></a><a class="docs-heading-anchor-permalink" href="#Evolution-of-the-tests-w.r.t.-Integration-of-an-IAL-release" title="Permalink"></a></h3><p>In the context of integration of an IAL release, it is suitable that the tests change as little as possible during the successive integration of contributions. Therefore we will set a version of the tests at the beginning of integration, and only adapt it for the contributions that require an update of the tests.<br/>Let&#39;s consider the process of integration of contribution branches on top of <code>CY49</code> to build a <code>CY49T1</code>. For that purpose we would have set a reference experiment on <code>CY49</code>, hereafter named <code>x0</code>, generated with an identified version of the tests. That version of the tests would then be updated with <code>x0</code> as <em>reference experiment</em> (<code>ref_xpid</code>), and tagged <code>DV49</code>. All contributions to <code>CY49T1</code> would then be required to be tested with this version <code>DV49</code> (hence against reference experiment <code>x0</code>). Cf. section <a href="user-guide.html#sect:set_a_ref_tests_version">[sect:set_a_ref_tests_version]</a>{reference-type=&quot;ref&quot; reference=&quot;sect:set<em>a</em>ref<em>tests</em>version&quot;} for more details about setting up a reference tests version and experiment.</p><p>Suppose then that we have 5 of these contribution branches based on <code>CY49</code>, and an integration branch named <code>dev_CY49_toT1</code>. These 4 contributions may have different levels of reproducibility: they may conserve the results or not; they may require resources/tests adaptations (e.g. namelist updates, ...) or not, in which case they come with tests adaptations in an associated tests branch. Cf. the table</p><table><tr><th style="text-align: left">branch</th><th style="text-align: left">results</th><th style="text-align: left">test XPID</th><th style="text-align: left">resources</th><th style="text-align: left">tested with</th><th style="text-align: left">integration XPID</th></tr><tr><td style="text-align: left"><code>b1</code></td><td style="text-align: left"><span>$=$</span></td><td style="text-align: left"><code>x1</code></td><td style="text-align: left"><span>$=$</span></td><td style="text-align: left"><code>DV49</code></td><td style="text-align: left"><code>xi1</code></td></tr><tr><td style="text-align: left"><code>b2</code></td><td style="text-align: left"><span>$\neq$</span></td><td style="text-align: left"><code>x2</code></td><td style="text-align: left"><span>$=$</span></td><td style="text-align: left"><code>DV49</code></td><td style="text-align: left"><code>xi2</code></td></tr><tr><td style="text-align: left"><code>b3</code></td><td style="text-align: left"><span>$=$</span></td><td style="text-align: left"><code>x3</code></td><td style="text-align: left"><span>$\neq$</span></td><td style="text-align: left"><span>$\rightarrow$</span> <code>DV49_b3</code></td><td style="text-align: left"><code>xi3</code></td></tr><tr><td style="text-align: left"><code>b4</code></td><td style="text-align: left"><span>$\neq$</span></td><td style="text-align: left"><code>x4</code></td><td style="text-align: left"><span>$\neq$</span></td><td style="text-align: left"><span>$\rightarrow$</span> <code>DV49_b4</code></td><td style="text-align: left"><code>xi4</code></td></tr></table><p>In parallel to the integration branch <code>dev_CY49_toT1</code>, we start a tests branch from <code>DV49</code> to collect the necessary adaptations of the tests, similarly named <code>dev_DV49_toT1</code>, which will be used to validate the integration branch, and updated as required along the integration.</p><p>In case some intermediate versions of the integration branch are tagged and some branches are based/rebased on these tagged versions, we could also tag accordingly the tests branch if necessary.<br/>The reference experiment for the integration branch is at any moment, <em>by default</em>, the experiment which tested the formerly integrated branch, e.g. the reference for <code>xi2</code> is <code>xi1</code>. However, that may not be true in some cases, some of these being potentially more tricky to validate, as will be shown in the following example.</p><h3 id="Steps-and-updates-in-the-Continuous-Integration-process"><a class="docs-heading-anchor" href="#Steps-and-updates-in-the-Continuous-Integration-process">Steps and updates in the Continuous Integration process</a><a id="Steps-and-updates-in-the-Continuous-Integration-process-1"></a><a class="docs-heading-anchor-permalink" href="#Steps-and-updates-in-the-Continuous-Integration-process" title="Permalink"></a></h3><ol><li><p>Integration of <code>b1</code> :</p><ul><li><p>Reference: <code>x0</code> is the default reference xp in <code>dev_DV49_toT1</code>   config file</p></li><li><p>Tests: <code>b1</code> did not require to adapt the tests <span>$\rightarrow$</span> we   can test with branch <code>dev_DV49_toT1</code> unchanged (and still equal   to <code>DV49</code>)</p></li></ul><p><code>davai-new_xp dev_CY49_toT1 -v dev_DV49_toT1</code><br/> <span>$~~~\hookrightarrow~~~$</span> <code>xi1 == x1 == x0</code></p></li><li><p>Integration of <code>b2</code> :</p><ul><li><p>Reference: <code>xi1</code> should normally be the reference xp, but since   its results are bit-identical to <code>x0</code> as opposed to <code>x2</code>, it is   more relevant to compare to <code>x2</code>, to check that the merge of   <code>b1</code> and <code>b2</code> still give the same results as <code>b2</code></p></li><li><p>Tests: <code>b2</code> did not require to adapt the tests <span>$\rightarrow$</span>   tests branch <code>DV49_toT1</code> unchanged</p></li></ul><p><code>davai-new_xp dev_CY49_toT1 -v DV49_toT1</code><br/> <span>$~~~$</span>and set <code>ref_xpid = x2</code><br/> <span>$~~~\hookrightarrow~~~$</span> <code>xi2 == x2</code></p><ul><li>then <code>ref_xpid</code> should be set to <code>xi2</code> in branch <code>DV49_toT1</code></li></ul></li><li><p>Integration of <code>b3</code> :</p><ul><li><p>Reference: <code>b3</code> does not change the results, so reference   experiment is as expected by default <code>xi2</code></p></li><li><p>Tests: <code>b3</code> requires tests adaptations (<code>DV49_b3</code>) <span>$\rightarrow$</span>   update <code>dev_DV49_toT1</code> by merging <code>DV49_b3</code> in</p></li></ul><p><code>davai-new_xp dev_CY49_toT1 -v DV49_toT1</code><br/> <span>$~~~\hookrightarrow~~~$</span> <code>xi3 == xi2</code></p></li><li><p>Integration of <code>b4</code> : <em>(where it becomes more or less tricky)</em></p><ul><li><p>Reference: <code>b4</code> changes the results, but the results of <code>xi3</code>   (current default reference for integration branch) are also   changed from <code>x0</code> (since <code>b2</code>) <span>$\rightarrow$</span> the reference   experiment becomes less obvious !<br/>  The choice of the reference should be made depending on the   width of impact on both sides:</p><ol><li><p>if there is more differences in the results between  <code>dev_CY49_toT1</code> and <code>CY49</code> than between <code>b4</code> and <code>CY49</code>:<br/> <span>$\rightarrow$</span> <code>xi3</code> should be taken as reference, and the  differences finely compared to those shown in <code>x4</code></p></li><li><p>if there is more differences in the results between <code>b4</code> and  <code>CY49</code> than between <code>dev_CY49_toT1</code> and <code>CY49</code>:<br/> <span>$\rightarrow$</span> <code>x4</code> should be taken as reference, and the  differences finely compared to those shown in <code>xi3’</code>, where  <code>xi3’</code> is a <em>&quot;witness&quot;</em> experiment comparing the integration  branch after integration of <code>b3</code> (commit <code>&lt;c3&gt;</code>) to <code>CY49</code>  (experiment <code>x0</code>):<br/> <code>davai-new_xp &lt;c3&gt; -v dev_DV49_toT1</code><br/> <span>$~~~$</span>and set <code>ref_xpid = x0</code><br/> <span>$~~~\hookrightarrow~~~$</span> <code>xi3’</code></p></li></ol><p>This is still OK if the tests affected by <code>dev_CY49_toT1</code> (via   <code>b2</code>) and the tests affected by <code>b4</code> are not the same subset, or   if at least if the affected fields are not the same. If they are   (e.g. numerical differences that propagate prognostically   through the model), the conclusion becomes much more difficult   !!!<br/>  In this case, we do not really have explicit recommendation; the   integrators should double-check the result of the merge with the   author of the contribution <code>b4</code>. Any idea welcome to sort it   out.</p></li><li><p>Tests: <code>b4</code> requires tests adaptations (<code>DV49_b4</code>) <span>$\rightarrow$</span>   update <code>dev_DV49_toT1</code> by merging in <code>DV49_b4</code> in</p></li></ul><p><code>davai-new_xp dev_CY49_toT1 -v dev_DV49_toT1</code><br/> <span>$~~~$</span>and set <code>ref_xpid = xi3|xi4</code><br/> <span>$~~~\hookrightarrow~~~$</span> <code>xi4</code></p></li></ol><h3 id="Setting-up-a-reference-version-of-the-tests-and-an-associated-reference-experiment"><a class="docs-heading-anchor" href="#Setting-up-a-reference-version-of-the-tests-and-an-associated-reference-experiment">Setting up a reference version of the tests and an associated reference experiment</a><a id="Setting-up-a-reference-version-of-the-tests-and-an-associated-reference-experiment-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-a-reference-version-of-the-tests-and-an-associated-reference-experiment" title="Permalink"></a></h3><p>! WORK IN PROGRESS...</p><p>We describe here how to set up a reference version of the tests and an associated reference experiment, typically for developments based on a given IAL release to be validated against this release.</p><p>For the example, let&#39;s consider <code>CY49</code> and setting up a <code>DV49</code> version for it, including its reference experiment, to validate the contributions to <code>CY49T1</code>.</p><ol><li><p>Choose an initial version of the tests you want to be used. It may  probably not be the previous reference one (e.g. <code>DV48T2</code> or  <code>dev_CY48T1_toT2</code>), as we may often want to modify or add tests in  between cycles.</p></li><li><p>In your development DAVAI-tests repository, make a branch starting  from this version and check it out, e.g.:<br/> <code>git checkout -b on_49 [&lt;chosen_initial_ref]</code></p></li><li><p>Set the reference experiment:<br/> <code>davai-new_xp CY49 -v on_49 -u ELP –origin &lt;URL of my DAVAI-tests repo&gt;</code><br/> <span>$\hookrightarrow$</span> <code>dv-xxxx-machine@user</code><br/> Note:</p><ul><li><p>As ELP usecase encompasses NRV, reference experiments should use   this usecase so it could be used as a reference for both   usecases.</p></li><li><p><code>–origin &lt;URL...&gt;</code> to clone that repo in which you created the   branch</p></li><li><p>in config of the experiment, set <code>archive_as_ref = True</code> : the   experiment will serve as a reference, so we want to archive its   results</p></li><li><p>in config of the experiment, set <code>ignore_reference = True</code> : if   you are confident enough with the test version, it may not be   useful/relevant to compare the experiment to any reference one.</p></li></ul></li><li><p>Run the experiment</p></li><li><p>Update the <code>DAVAI-tests</code> repository:</p><ul><li><p>default config file for this machine (<code>conf/&lt;machine&gt;.ini</code>: with   the name of this experiment as <code>ref_xpid</code> (and potentially the   usecase chosen in minor case as <code>ref_vconf</code>)</p></li><li><p><code>README.md</code>: the table of correspondance of branches and tests</p></li></ul><p>Then commit, tag (<code>DV49</code>) and push:</p><pre><code class="nohighlight hljs">   git commit -am &quot;Set reference experiment for &lt;machine&gt; as &lt;dv-xxxx-machine@user&gt;&quot;
   git tag DV49
   git push &lt;remote&gt;
   git push &lt;remote&gt; DV49</code></pre></li></ol><p>This way the tests experiment generated using <code>davai-new_xp -v DV49</code> will use this version and be compared to this reference experiment.</p><h2 id="Internal-organization-of-DAVAÏ"><a class="docs-heading-anchor" href="#Internal-organization-of-DAVAÏ">Internal organization of DAVAÏ</a><a id="Internal-organization-of-DAVAÏ-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-organization-of-DAVAÏ" title="Permalink"></a></h2><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>IAL = <strong>I</strong>FS-<strong>A</strong>rpege-<strong>L</strong>AM</li><li class="footnote" id="footnote-2"><a class="tag is-link" href="#citeref-2">2</a><code>git commit –amend</code></li><li class="footnote" id="footnote-3"><a class="tag is-link" href="#citeref-3">3</a>including upstream tasks that produce flow-resources for the targeted test, as long as the resources stay in cache</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../atos_bologna.html">« Atos</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.0.1 on <span class="colophon-date" title="Tuesday 24 October 2023 09:53">Tuesday 24 October 2023</span>. Using Julia version 1.9.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
